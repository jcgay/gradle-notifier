plugins {
    id 'com.github.kt3k.coveralls' version '2.8.2'
    id "com.bmuschko.nexus" version "2.3.1"
    id "pl.allegro.tech.build.axion-release" version "1.8.1"
    id "com.jfrog.bintray" version "1.8.4"
    id 'com.github.ben-manes.versions' version '0.24.0'
    id "io.codearte.nexus-staging" version "0.11.0"
    id 'java-gradle-plugin'
    id 'groovy'
    id 'jacoco'
    id "com.gradle.plugin-publish" version "0.10.1"
}

group = 'fr.jcgay'

scmVersion {
    tag {
        prefix = 'v'
        versionSeparator = ''
        deserialize = { config, position, tagName -> if (tagName.count('.') == 1) "$tagName.0" - 'v' else tagName - 'v' }
    }
}

project.version = scmVersion.version

sourceCompatibility = 1.8
targetCompatibility = 1.8

repositories {
    mavenCentral()
}

dependencies {
    compile gradleApi()
    compile localGroovy()

    compile group: 'fr.jcgay.send-notification', name: 'send-notification', version: '0.16.0'

    testImplementation gradleTestKit()
    testCompile group: 'org.assertj', name: 'assertj-core', version: '3.12.2'
    testCompile(group: 'org.spockframework', name:'spock-core', version: '1.3-groovy-2.5')
    testCompile group: 'com.github.stefanbirkner', name: 'system-rules', version: '1.19.0'
    testRuntime group: 'cglib', name: 'cglib-nodep', version: '3.2.10'
}

release.dependsOn build

uploadArchives.doFirst {
    if (!project.properties.keySet().containsAll('nexusUsername', 'nexusPassword')) {
        throw new StopExecutionException("Nexus authentication is not correctly defined, set 'nexusUsername' and 'nexusPassword' properties")
    }
}

publishPlugins.doFirst {
    if (!project.properties.keySet().containsAll('gradle.publish.key', 'gradle.publish.secret')) {
        throw new StopExecutionException("Gradle plugin portal credentials not correctly defined, set 'gradle.publish.secret' and 'gradle.publish.secret' properties")
    }
}

bintrayUpload.doFirst {
    if (!project.properties.keySet().containsAll('bintrayUsername', 'bintrayKey')) {
        throw new StopExecutionException("Bintray credentials not correctly defined, set 'bintrayUsername' and 'bintrayKey' properties")
    }
}

task('publish', dependsOn: [uploadArchives, closeAndReleaseRepository, publishPlugins, bintrayUpload])
closeAndReleaseRepository.mustRunAfter uploadArchives
publishPlugins.mustRunAfter uploadArchives
bintrayUpload.mustRunAfter uploadArchives

modifyPom {
    project {
        name 'gradle-notifier'
        packaging 'jar'
        description 'A plugin to have desktop notification when a build ends'
        url 'https://github.com/jcgay/gradle-notifier'

        scm {
            connection 'scm:git:git://github.com/jcgay/gradle-notifier.git'
            developerConnection 'scm:git:git@github.com:jcgay/gradle-notifier.git'
            url 'https://github.com/jcgay/gradle-notifier.git'
        }

        licenses {
            license {
                name 'The MIT License'
                url 'http://opensource.org/licenses/MIT'
            }
        }

        developers {
            developer {
                id 'jcgay'
                name 'Jean-Christophe Gay'
                email 'contact@jeanchristophegay.com'
            }
        }
    }
}

pluginBundle {
    website = 'https://github.com/jcgay/gradle-notifier'
    vcsUrl = 'https://github.com/jcgay/gradle-notifier'
    description = 'A plugin to have desktop notification when a build ends'
    tags = ['notification', 'desktop', 'growl', 'snarl', 'notification center', 'anybar', 'notify-send', 'pushbullet', 'toaster']

    plugins {
        gradleNotifierPlugin {
            id = 'fr.jcgay.gradle-notifier'
            displayName = 'Gradle Notifier'
        }
    }
}

jacocoTestReport {
    reports {
        xml.enabled = true
        html.enabled = true
    }
}

bintray {
    user = project.properties['bintrayUsername']
    key = project.properties['bintrayKey']
    configurations = ['archives']
    pkg {
        repo = 'maven'
        name = 'gradle-notifier'
        licenses = ['MIT']
        vcsUrl = 'https://github.com/jcgay/gradle-notifier.git'
        version {
            name = project.version
            desc = "Gradle Notifier ${project.version}"
            vcsTag = "v${project.version}"
        }
    }
}
